@page "/predictionsgraphics"
@inject IClimateService ClimateService

<PageTitle>Predictions Journal</PageTitle>

<h3>Графики прогнозов</h3>

@if (Monitorings == null)
{
    <p><em>Loading...</em></p>
}
else
{
    if (HasData)
    {
        <Line Data="ActualAndPredictedTemperature" Config="TemperatureDataLineConfig"></Line>
        <Line Data="ActualAndPredictedHumidity" Config="HumidityDataLineConfig"></Line>
        <Line Data="Accuracy" Config="AccuracyLineConfig"></Line>
    }
    else
    {
        <p><em>Sorry, no data to show...</em></p>
    }
}

@code{

    List<MonitoringData> Monitorings;

    bool HasData = false;

    LineConfig TemperatureDataLineConfig;
    LineConfig HumidityDataLineConfig;
    LineConfig AccuracyLineConfig;

    List<object> ActualAndPredictedTemperature;
    List<object> ActualAndPredictedHumidity;
    List<object> Accuracy;

    protected override async Task OnInitializedAsync()
    {
        Monitorings = await ClimateService.GetClimateRecordsAsync(25);

        HasData = Monitorings.Count >= 2;

        if (HasData is false)
        {
            return;    
        }

        ActualAndPredictedTemperature = GetTemperatureData(Monitorings);
        ActualAndPredictedHumidity = GetHumidityData(Monitorings);
        Accuracy = GetAccuracyData(Monitorings);

        TemperatureDataLineConfig = GetTemperatureLineConfig();
        HumidityDataLineConfig = GetHumidityDataConfig();
        AccuracyLineConfig = GetAccuracyConfig();
    }

    private List<object> GetTemperatureData(List<MonitoringData> monitorings)
    {
        List<object> temperatureData = new List<object>();

        for (int i = 0; i < Monitorings.Count; i++)
        {
            if (i < Monitorings.Count - 1)
            {
                temperatureData.Add(new
                {
                    time = Monitorings[i].MeasurementTime.ToString("HH:mm:ss"),
                    value = Monitorings[i].PredictedTemperature,
                    type = "Predicted"
                });
            }

            if (i > 0)
            {
                temperatureData.Add(new
                {
                    time = Monitorings[i - 1].MeasurementTime.ToString("HH:mm:ss"),
                    value = Monitorings[i].PreviousTemperature,
                    type = "Measured"
                });
            }
        }

        return temperatureData;
    }

    private List<object> GetHumidityData(List<MonitoringData> monitorings)
    {
        List<object> humidityData = new List<object>();

        for (int i = 0; i < monitorings.Count; i++)
        {
            if (i < monitorings.Count - 1)
            {
                humidityData.Add(new
                {
                    time = monitorings[i].MeasurementTime.ToString("HH:mm:ss"),
                    value = monitorings[i].PredictedHumidity,
                    type = "Predicted"
                });
            }

            if (i > 0)
            {
                humidityData.Add(new
                {
                    time = monitorings[i - 1].MeasurementTime.ToString("HH:mm:ss"),
                    value = monitorings[i].PreviousHumidity,
                    type = "Measured"
                });
            }
        }

        return humidityData;
    }

    private List<object> GetAccuracyData(List<MonitoringData> monitorings)
    {
        List<object> temperatureAccuracy = new List<object>();

        for (int i = 0; i < monitorings.Count; i++)
        {
            temperatureAccuracy.Add(new
            {
                time = monitorings[i].MeasurementTime.ToString("HH:mm:ss"),
                value = monitorings[i].PredictedTemperatureAccuracy,
                type = "Temperature"
            });

            temperatureAccuracy.Add(new
            {
                time = monitorings[i].MeasurementTime.ToString("HH:mm:ss"),
                value = monitorings[i].PredictedHumidityAccuracy,
                type = "Humidity"
            });
        }

        //if (temperatureAccuracy.Count >= 2)
        //{
        //    temperatureAccuracy.Add(new
        //    {
        //        time = temperatureAccuracy.First(),
        //        value = 100f,
        //        type = "Result"
        //    });
        //    temperatureAccuracy.Add(new
        //    {
        //        time = temperatureAccuracy.Last(),
        //        value = 100f,
        //        type = "Result"
        //    });
        //}

        return temperatureAccuracy;
    }

    private LineConfig GetTemperatureLineConfig()
    {
        var config = GetBaseLineConfig();

        config.Title.Text = "Действительная и спрогнозированная температуры";
        config.YAxis.Title.Text = "Градусы °C";

        return config;
    }

    private LineConfig GetHumidityDataConfig()
    {
        var config = GetBaseLineConfig();

        config.Title.Text = "Действительная и спрогнозированная влажности";
        config.YAxis.Title.Text = "Показатели влажности %";

        return config;
    }

    private LineConfig GetAccuracyConfig()
    {
        var config = GetBaseLineConfig();

        config.Title.Text = "Точность прогноза температуры";
        config.YAxis.Title.Text = "Точнсть прогноза %";
        //config.YAxis.Max = Accuracy.Max();
        //config.YAxis.Min = Accuracy.Min();

        return config;
    }

    private LineConfig GetBaseLineConfig()
    {
        return new LineConfig()
        {
            Title = new Title()
            {
                Visible = true,
                Style = new TextStyle()
                {
                    Fill = "#000",
                    FontSize = 20
                }
            },
            Padding = "auto",
            ForceFit = true,
            XField = "time",
            YField = "value",
            SeriesField = "type",
            Point = new LineViewConfigPoint()
            {
                Style = new GraphicStyle() { LineWidth = 3, FillOpacity = 5 },
                Size = 10,
                Visible = true,
                Shape = "diamond"
            },
            LineStyle = new LineStyle()
            {
                LineWidth = 8
            },
            Legend = new Legend()
            {
                Position = "top-right",
                Text = new LegendText()
                {
                    Style = new TextStyle()
                    {
                        Fill = "#000",
                        FontSize = 20
                    }
                }
            },
            XAxis = new ValueCatTimeAxis()
            {
                Title = new BaseAxisTitle()
                {
                    Text = "Время",
                    Style = new TextStyle()
                    {
                        FontSize = 16
                    },
                    Visible = true
                },
                Visible = true,
                TickLine = new BaseAxisTickLine()
                {
                    Visible = true,
                    Style = new LineStyle()
                    {
                        LineWidth = 2,
                        Stroke = "#aaa"
                    },
                },
                Line = new BaseAxisLine()
                {
                    Visible = true,
                    Style = new LineStyle()
                    {
                        Stroke = "#aaa"
                    }
                },
                Grid = new BaseAxisGrid()
                {
                    Visible = true,
                    Line = new BaseAxisGridLine()
                    {
                        Type = "",
                        Style = new LineStyle()
                        {
                            Stroke = "#ddd",
                            LineDash = new int[] { 4, 2 }
                        }
                    }
                }
            },
            YAxis = new ValueAxis()
            {
                Title = new BaseAxisTitle()
                {
                    Style = new TextStyle()
                    {
                        FontSize = 16,
                    },
                    AutoRotate = true,
                    Visible = true
                },
                Visible = true
            },
        };
    }
}
