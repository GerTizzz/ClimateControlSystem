using Application.Primitives;
using Application.Services.Implementations;

namespace ApplicationTests.PredictionEngineTests
{
    public sealed class PredictionEngineTests
    {
        private readonly string[] _lstmTestData = {
            "17.91;-13.7;20",
            "17.61;-8.4;18",
            "16.9;-8.25;18",
            "17.25;-8.1;18",
            "17.17;-7.95;18",
            "17.61;-7.8;18",
            "17.67;-7.65;18",
            "17.73;-7.5;19",
            "18.32;-7.35;18",
            "17.33;-7.2;19",
            "17.96;-7.05;18",
            "17.36;-6.9;18",
            "17.55;-6.75;18",
            "17.74;-6.6;18",
            "17.68;-6.45;18",
            "17.35;-6.3;19",
            "18.05;-6.15;18",
            "17.8;-6;18",
            "17.95;-5.85;18",
            "18.11;-5.7;18",
            "18.21;-14;21",
            "18.86;-2;18",
            "18.57;-14.06;20",
            "17.74;-2;17",
            "18.09;-13.79;20",
            "18.02;-14.11;21",
            "18.68;-2;18",
            "18.37;-14.17;21",
            "19.02;-2;17",
            "18.1;-13.88;20",
            "18.06;-14.22;22",
            "19.37;-2;17",
            "17.75;-14.28;21",
            "18.85;-2;16",
            "17.47;-13.97;20",
            "18.04;-13.52;19",
            "17.06;-8.51;19",
            "17.77;-14.33;22",
            "19;-2;18",
            "18.85;-5.84;19",
            "18.52;-13.89;20",
            "17.76;-14.39;22",
            "19.31;-2.11;18",
            "18.72;-2;17",
            "18;-14.06;19",
            "17.32;-14.44;22",
            "18.93;-2;17",
            "18.02;-14.5;22",
            "19.23;-2;16",
            "17.62;-14.15;19",
            "17.03;-14.56;22",
            "19.25;-2;14",
            "15.87;-14.61;21",
            "18.07;-2;17",
            "17.56;-14.23;21",
            "18.33;-13.33;19",
            "17.42;-8.62;18",
            "17.21;-14.67;22",
            "18.98;-2;16",
            "17;-14.72;22",
            "19.06;-2;17",
            "17.63;-14.32;21",
            "18.78;-5.99;19",
            "18.46;-13.78;19",
            "17.01;-14.78;22",
            "19.22;-2.22;19",
            "19.48;-2;15",
            "16.73;-14.83;22",
            "18.66;-2;16",
            "16.89;-14.41;19",
            "17.04;-14.89;21",
            "18.59;-2;15",
            "16.59;-14.94;23",
            "19.39;-2;16",
            "17.12;-12.9;19",
            "16.83;-14.5;21",
            "18.14;-13.15;19",
            "17.45;-8.73;17",
            "16.34;-15;19",
            "16.35;-14.89;18",
            "15.51;-14.78;20",
            "16.73;-14.67;19",
            "16.91;-14.56;19",
            "17.04;-14.44;19",
            "16.42;-14.33;19",
            "16.3;-14.22;19",
            "16.69;-14.11;19",
            "16.75;-14;19",
            "16.67;-13.89;17",
            "15.41;-13.78;19",
            "16.72;-13.67;19",
            "16.72;-13.56;20",
            "17.34;-13.44;19",
            "16.75;-13.33;19",
            "17.26;-13.22;19",
            "16.67;-13.11;19",
            "16.72;-13;19",
            "16.61;-12.89;18",
            "15.94;-12.78;20",
            "17.23;-12.67;18",
            "16.24;-12.56;20",
            "17.66;-12.44;18",
            "16.44;-12.33;20",
            "17.43;-12.22;19",
            "17.65;-12.11;19",
            "17.72;-12;19",
            "17.35;-11.89;20",
            "18.01;-11.78;20",
            "18.36;-11.67;19",
            "17.65;-11.56;19",
            "17.68;-11.44;20",
            "18.08;-11.33;19",
            "17.96;-11.22;20",
            "18.34;-11.11;20",
            "18.46;-11;20",
            "18.56;-10.94;19",
            "17.88;-10.89;20",
            "18.11;-10.83;20",
            "18.76;-10.78;19",
            "18.08;-10.72;20",
            "18.32;-10.67;19",
            "17.84;-10.61;19",
            "17.97;-10.56;20",
            "18.19;-10.5;20",
            "18.46;-10.45;20",
            "18.66;-10.39;19",
            "18.17;-10.33;19",
            "18.19;-10.28;20",
            "18.68;-10.22;19",
            "18.09;-10.17;19",
            "17.93;-10.11;20",
            "18.47;-10.06;20",
            "18.49;-10;20",
            "18.55;-9.83;20",
            "18.78;-9.67;20",
            "18.59;-9.5;19",
            "18.26;-9.33;19",
            "17.8;-9.17;20",
            "18.78;-9;18",
            "17.8;-8.83;19",
            "17.9;-8.67;18",
            "16.93;-8.5;19",
            "18.06;-8.33;19",
            "18.18;-8.17;18" };

        [Test]
        public async Task CheckPrediction()
        {
            var modelDirectory = string.Join("\\", Directory.GetCurrentDirectory()
                .Split('\\')
                .TakeWhile(str => str != "tests")) + "\\mlModel\\lstm";

            var predictionEngine = new PredictionEngine(modelDirectory);

            var features = new List<float>();

            for (var i = 0; i < _lstmTestData.Length; i++)
            {
                var parsedFeatures = _lstmTestData[i].Split(";").ToArray();
                foreach (var feature in parsedFeatures)
                {
                    features.Add(float.Parse(feature.Replace('.', ',')));
                }
            }

            //var features = FeaturesData.Replace('.', ',').Split(';').Select(float.Parse).ToArray();

            var request = new TensorPredictionRequest()
            {
                serving_default_lstm_input = features.ToArray()
            };

            var prediction = await predictionEngine.Predict(request);

            var print = "Температура воздуха внутри ЦОД составит: " +
                        (request.serving_default_lstm_input[^3] +
                        prediction.StatefulPartitionedCall[0]);

            Console.WriteLine(print);

            Assert.That(prediction, Is.Not.Null);
        }
    }
}
